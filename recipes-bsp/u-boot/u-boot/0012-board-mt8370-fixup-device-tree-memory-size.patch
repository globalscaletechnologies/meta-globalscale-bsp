From 2cb9e9f16bfb74e3765c00e5138006cb3dc12449 Mon Sep 17 00:00:00 2001
From: Jason Hung <jhung@globalscaletechnologies.com>
Date: Mon, 13 Jan 2025 09:24:57 +0800
Subject: [PATCH 2/4] board: mt8370: fixup device-tree memory size

update onboard ddr size to fix device-tree's memory size
---
 board/mediatek/mt8370/mt8370_evk.c        | 14 ++++++++++++++
 configs/globalscale_mt510ss_evk_defconfig |  5 ++++-
 2 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/board/mediatek/mt8370/mt8370_evk.c b/board/mediatek/mt8370/mt8370_evk.c
index 3045a44f51..90e01e4ae9 100644
--- a/board/mediatek/mt8370/mt8370_evk.c
+++ b/board/mediatek/mt8370/mt8370_evk.c
@@ -154,3 +154,17 @@ int board_init(void)
 
 	return 0;
 }
+
+#ifdef CONFIG_OF_BOARD_SETUP
+int ft_board_setup(void *blob, struct bd_info *bd)
+{
+	u64 base[CONFIG_NR_DRAM_BANKS];
+	u64 size[CONFIG_NR_DRAM_BANKS];
+
+	base[0] = gd->bd->bi_dram[0].start;
+	size[0] = gd->bd->bi_dram[0].size;
+
+	fdt_fixup_memory_banks(blob, base, size, 1);
+	return 0;
+}
+#endif /* CONFIG_OF_BOARD_SETUP */
diff --git a/configs/globalscale_mt510ss_evk_defconfig b/configs/globalscale_mt510ss_evk_defconfig
index 2c5aa02075..31553d10c3 100644
--- a/configs/globalscale_mt510ss_evk_defconfig
+++ b/configs/globalscale_mt510ss_evk_defconfig
@@ -20,7 +20,6 @@ CONFIG_DEBUG_UART=y
 CONFIG_DISTRO_DEFAULTS=y
 CONFIG_FIT=y
 CONFIG_FIT_SIGNATURE=y
-# CONFIG_ARCH_FIXUP_FDT_MEMORY is not set
 CONFIG_DEFAULT_FDT_FILE="gti-mt510ss-evk"
 # CONFIG_DISPLAY_BOARDINFO is not set
 # CONFIG_CMD_CONSOLE is not set
@@ -123,3 +122,7 @@ CONFIG_EFI_CAPSULE_AUTHENTICATE=y
 CONFIG_LMB_MAX_REGIONS=16
 CONFIG_SYSINFO=y
 CONFIG_SYSINFO_SMBIOS=y
+CONFIG_OF_BOARD_SETUP=y
+CONFIG_OF_LIBFDT=y
+CONFIG_ARCH_FIXUP_FDT_MEMORY=y
+CONFIG_MTK_PLAT_GET_DRAM_SIZE=y
-- 
2.47.1

