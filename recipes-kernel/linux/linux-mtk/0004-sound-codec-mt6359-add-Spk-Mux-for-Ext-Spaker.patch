From ae73dd1359640c3a1a11ae6c8e0f6da9335ac3ce Mon Sep 17 00:00:00 2001
From: Jason Hung <jhung@globalscaletechnologies.com>
Date: Tue, 8 Oct 2024 09:16:29 +0800
Subject: [PATCH 4/8] sound: codec: mt6359: add Spk Mux for Ext Spaker

add Spk Mux for Ext Spaker
---
 sound/soc/codecs/mt6359.c | 39 +++++++++++++++++++++++++++++++++------
 1 file changed, 33 insertions(+), 6 deletions(-)

diff --git a/sound/soc/codecs/mt6359.c b/sound/soc/codecs/mt6359.c
index d08ab807967f..eaf2659e3b48 100644
--- a/sound/soc/codecs/mt6359.c
+++ b/sound/soc/codecs/mt6359.c
@@ -725,6 +725,24 @@ static SOC_VALUE_ENUM_SINGLE_DECL(pga_3_mux_map_enum,
 static const struct snd_kcontrol_new pga_3_mux_control =
 	SOC_DAPM_ENUM("PGA 3 Select", pga_3_mux_map_enum);
 
+static const char * const spk_mux_map[] = {
+	"Disconnect", "Connect",
+};
+
+static int spk_mux_map_value[] = {
+	0, 1,
+};
+
+static SOC_VALUE_ENUM_SINGLE_DECL(spk_out_mux_map_enum,
+				SND_SOC_NOPM,
+				0,
+				1,
+				spk_mux_map,
+				spk_mux_map_value);
+
+static const struct snd_kcontrol_new spk_out_mux_control =
+	SOC_DAPM_ENUM("SPK Switch", spk_out_mux_map_enum);
+
 static int mt_sgen_event(struct snd_soc_dapm_widget *w,
 			 struct snd_kcontrol *kcontrol,
 			 int event)
@@ -1978,14 +1996,13 @@ static int spk_event(struct snd_soc_dapm_widget *w,
 			gpio_set_value(priv->amp_gpio, 1);
 		}
 		break;
-	case SND_SOC_DAPM_POST_PMD:
+	case SND_SOC_DAPM_PRE_PMD:
 		// turn off the amplifier
 		if (priv->amp_gpio != -1) {
 			gpio_set_value(priv->amp_gpio, 0);
 		}
 		break;
 	}
-
 	return 0;
 }
 
@@ -2161,8 +2178,13 @@ static const struct snd_soc_dapm_widget mt6359_dapm_widgets[] = {
 			   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_PRE_PMD),
 
 	/* SPK */
-	SND_SOC_DAPM_SPK("Speaker L", spk_event),
-	SND_SOC_DAPM_SPK("Speaker R", spk_event),
+	SND_SOC_DAPM_MUX_E("Spk Mux", SND_SOC_NOPM, 0, 0,
+			   &spk_out_mux_control,
+			   spk_event,
+			   SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_PRE_PMD),
+
+	SND_SOC_DAPM_OUTPUT("Ext Spk L"),
+	SND_SOC_DAPM_OUTPUT("Ext Spk R"),
 
 	/* Outputs */
 	SND_SOC_DAPM_OUTPUT("Receiver"),
@@ -2170,6 +2192,7 @@ static const struct snd_soc_dapm_widget mt6359_dapm_widgets[] = {
 	SND_SOC_DAPM_OUTPUT("Headphone R"),
 	SND_SOC_DAPM_OUTPUT("Headphone L Ext Spk Amp"),
 	SND_SOC_DAPM_OUTPUT("Headphone R Ext Spk Amp"),
+	SND_SOC_DAPM_OUTPUT("Headphone R"),
 	SND_SOC_DAPM_OUTPUT("LINEOUT L"),
 
 	/* SGEN */
@@ -2574,8 +2597,12 @@ static const struct snd_soc_dapm_route mt6359_dapm_routes[] = {
 	{"Headphone L Ext Spk Amp", NULL, "HP Mux"},
 	{"Headphone R Ext Spk Amp", NULL, "HP Mux"},
 
-	{"Speaker L", NULL, "Headphone L"},
-	{"Speaker R", NULL, "Headphone R"},
+	/* Ext Spk */
+	{"Spk Mux", "Connect", "Headphone L"},
+	{"Spk Mux", "Connect", "Headphone R"},
+
+	{"Ext Spk L", NULL, "Spk Mux"},
+	{"Ext Spk R", NULL, "Spk Mux"},
 
 	/* Receiver Path */
 	{"RCV Mux", "Voice Playback", "DACL"},
-- 
2.47.1

